<section class="fetchly-arrivals" aria-label="New Arrivals">
  <div class="fetchly-arrivals__inner">
    <header class="fetchly-arrivals__header">
      {% if section.settings.kicker != blank %}
        <p class="fetchly-arrivals__kicker">{{ section.settings.kicker }}</p>
      {% endif %}

      {% if section.settings.heading != blank %}
        <h2 class="fetchly-arrivals__heading">{{ section.settings.heading }}</h2>
      {% endif %}

      {% if section.settings.subheading != blank %}
        <p class="fetchly-arrivals__subheading">{{ section.settings.subheading }}</p>
      {% endif %}
    </header>

    {% assign col = section.settings.collection %}
    {% if col == blank %}
      <p class="fetchly-arrivals__empty">Select a collection in section settings.</p>
    {% else %}
    <div class="fetchly-arrivals__grid">
    {% assign limit = section.settings.products_limit | default: 6 %}
    {% assign shown = 0 %}

    {% for product in col.products limit: limit %}
        {% render 'fetchly-product-card',
        product: product,
        rating_value: section.settings.rating_value,
        rating_count: section.settings.rating_count
        %}
        {% assign shown = shown | plus: 1 %}
    {% endfor %}

    {% if shown == 0 and col.products.size > 0 %}
        {% assign shown = 1 %}
    {% endif %}

    {% if col.products.size > 0 %}
        {% assign remaining = limit | minus: shown %}
        {% if remaining > 0 %}
        {% assign p0 = col.products.first %}
        {% for i in (1..remaining) %}
            {% render 'fetchly-product-card',
            product: p0,
            rating_value: section.settings.rating_value,
            rating_count: section.settings.rating_count
            %}
        {% endfor %}
        {% endif %}
    {% endif %}
    </div>

    {% endif %}
  </div>
</section>

<style>
.fetchly-arrivals {
  background: #f6efe7;
  padding: 64px 0;
}

.fetchly-arrivals__inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 22px;
}

.fetchly-arrivals__header {
  text-align: center;
  margin-bottom: 34px;
}

.fetchly-arrivals__kicker {
  margin: 0 0 6px;
  font-size: 12px;
  letter-spacing: 2px;
  text-transform: uppercase;
  opacity: 0.7;
  color: #391212;
}

.fetchly-arrivals__heading {
  margin: 0;
  font-size: 54px;
  line-height: 1.05;
  color: #391212;

}

.fetchly-arrivals__subheading {
  margin: 10px 0 0;
  font-size: 14px;
  opacity: 0.75;
  color: #391212;

}

.fetchly-arrivals__empty {
  text-align: center;
  opacity: 0.7;
}

.fetchly-arrivals__grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 34px;
}

@media (max-width: 900px) {
  .fetchly-arrivals__grid { grid-template-columns: repeat(2, 1fr); }
  .fetchly-arrivals__heading { font-size: 38px; }
}

@media (max-width: 560px) {
  .fetchly-arrivals__grid { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
  .fetchly-arrivals__grid {
    display: grid;
    grid-template-columns: none !important;
    grid-auto-flow: column;
    grid-auto-columns: 85vw;
    gap: 24px;
    overflow-x: auto;
    padding: 0 22px;
    scroll-snap-type: x mandatory;
    scroll-padding-left: 22px;
  }

  .fetchly-arrivals__grid > * {
    scroll-snap-align: start;
    min-width: 0;
  }
}

</style>

<script>
const updateCartCountUI = (count) => {
  const n = Number(count || 0);

  document.querySelectorAll('cart-icon').forEach((el) => {
    el.setAttribute('data-count', String(n));
    el.setAttribute('count', String(n));
    try { el.count = n; } catch (e) {}
  });

  document.querySelectorAll('[data-testid="cart-bubble"], .cart-bubble__text-count').forEach((el) => {
    el.textContent = String(n);
    el.classList.toggle('hidden', n === 0);
  });

  document.querySelectorAll('.cart-bubble').forEach((b) => {
    b.classList.toggle('visually-hidden', n === 0);
  });
};

const refreshCart = async () => {
  const cartRes = await fetch('/cart.js', { headers: { Accept: 'application/json' } });
  if (!cartRes.ok) throw new Error('cart.js failed');
  const cart = await cartRes.json();

  updateCartCountUI(cart.item_count);

  const cartItemsEl = document.querySelector('cart-items-component[data-section-id]');
  const sectionId = cartItemsEl?.dataset.sectionId;

  if (sectionId) {
    const secRes = await fetch(`/?sections=${encodeURIComponent(sectionId)}`, {
      headers: { Accept: 'application/json' }
    });

    if (secRes.ok) {
      const sections = await secRes.json();
      const html = sections?.[sectionId];

      if (html) {
        const newDoc = new DOMParser().parseFromString(html, 'text/html');
        const newCartItems = newDoc.querySelector('cart-items-component');
        const currentCartItems = document.querySelector('cart-items-component');

        if (newCartItems && currentCartItems) {
          currentCartItems.innerHTML = newCartItems.innerHTML;
        }
      }
    }
  }

  return cart;
};

document.addEventListener('click', async (e) => {
  const btn = e.target.closest('[data-fetchly-atc]');
  if (!btn) return;

  e.preventDefault();

  const card = btn.closest('[data-fetchly-card]');
  if (!card) return;

  const idRaw = card.querySelector('input[name="id"]')?.value;
  const id = Number(idRaw);

  if (!id || Number.isNaN(id)) return;

  btn.disabled = true;
  const original = btn.textContent;
  btn.textContent = 'Adding...';

  try {
    const body = new URLSearchParams();
    body.append('id', String(id));
    body.append('quantity', '1');

    const res = await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
      body: body.toString()
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data?.description || data?.message || 'Add failed');

    btn.textContent = 'Added âœ“';

    await refreshCart();

    setTimeout(() => {
      btn.textContent = original;
      btn.disabled = false;
    }, 900);
  } catch (err) {
    btn.textContent = 'Error';
    setTimeout(() => {
      btn.textContent = original;
      btn.disabled = false;
    }, 1200);
  }
});

</script>



{% schema %}
{
  "name": "Fetchly New Arrivals",
  "settings": [
    { "type": "text", "id": "kicker", "label": "Kicker", "default": "FEATURED" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "New Arrivals" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Handpicked styles designed to stand out." },

    { "type": "collection", "id": "collection", "label": "Collection" },
    { "type": "range", "id": "products_limit", "label": "Products to show", "min": 1, "max": 12, "step": 1, "default": 6 },

    { "type": "range", "id": "rating_value", "label": "Rating (x10)", "min": 0, "max": 50, "step": 1, "default": 41 },
    { "type": "number", "id": "rating_count", "label": "Rating count", "default": 10867 }
  ],
  "presets": [
    { "name": "Fetchly New Arrivals" }
  ]
}
{% endschema %}
