<section class="fetchly-slider" aria-label="{{ section.settings.aria_label | escape }}">
  <div class="fetchly-slider__inner">
    {% if section.settings.heading != blank %}
      <h2 class="fetchly-slider__heading">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="fetchly-slider__track" id="SliderTrack-{{ section.id }}">
      {% for block in section.blocks %}
        <article class="fetchly-slide" {{ block.shopify_attributes }}>
          <a class="fetchly-slide__link" href="{{ block.settings.link | default: '#' }}">
            <div class="fetchly-slide__media">
              {% if block.settings.image != blank %}
                <img
                  src="{{ block.settings.image | image_url: width: 800 }}"
                  srcset="
                    {{ block.settings.image | image_url: width: 360 }} 360w,
                    {{ block.settings.image | image_url: width: 540 }} 540w,
                    {{ block.settings.image | image_url: width: 720 }} 720w,
                    {{ block.settings.image | image_url: width: 900 }} 900w
                  "
                  sizes="(max-width: 768px) 220px, 260px"
                  alt="{{ block.settings.image.alt | escape }}"
                  loading="lazy"
                  class="fetchly-slide__img"
                >
              {% else %}
                <div class="fetchly-slide__placeholder"></div>
              {% endif %}

              {% if block.settings.label != blank %}
                <span class="fetchly-slide__label">{{ block.settings.label }}</span>
              {% endif %}
            </div>
          </a>
        </article>
      {% endfor %}
    </div>

      {% if section.settings.show_dots %}
        <div class="fetchly-slider__dots" data-dots aria-hidden="false"></div>
      {% endif %}
  </div>
</section>

<style>
.fetchly-slider {
  background: var(--fetchly-slider-bg, #f6efe7);
  padding: 120px 0;
}

.fetchly-slider__inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 22px;
}

.fetchly-slider__heading {
  margin: 0 0 18px;
  font-size: 28px;
  line-height: 1.2;
}

.fetchly-slider__track {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: 160px;
  gap: 25px;

  overflow-x: auto;
  overscroll-behavior-x: contain;
  scroll-snap-type: x mandatory;
  scroll-padding-left: 22px;
  padding-bottom: 14px;

  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.fetchly-slider__track::-webkit-scrollbar { display: none; }

.fetchly-slide {
  scroll-snap-align: start;
}

.fetchly-slide__media {
  position: relative;
  width:150px;
  height:150px;
  border-radius: 14px;
  overflow: hidden;
  background: rgba(0,0,0,0.05);
}

.fetchly-slide__img {
  width: 100%;
  height: 150px;
  object-fit: cover;
  display: block;
}

.fetchly-slide__placeholder {
  width: 100%;
  height: 170px;
}

.fetchly-slide__label {
  position: absolute;
  left: 14px;
  bottom: 12px;
  padding: 8px 2vh;
  border-radius: 10px;
  font-size: 12px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #fff;
  background: rgba(0,0,0,0.0);
  backdrop-filter: blur(1.5px);
  border: 1px solid rgba(255,255,255,1);
}

.fetchly-slider__dots {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 18px;
}

.fetchly-dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
  border: 0;
  background: rgba(0,0,0,0.18);
  cursor: pointer;
}
.fetchly-dot.is-active {
  background: rgba(0,0,0,0.7);
}

@media (max-width: 768px) {
  .fetchly-slider { padding: 28px 0; }
  .fetchly-slider__track {
    grid-auto-columns: 220px;
    gap: 16px;
  }
  .fetchly-slide__img,
  .fetchly-slide__placeholder {
    height: 150px;
  }
    .fetchly-slider { padding: 28px 0; }

  .fetchly-slider__track {
    gap: 16px;
    grid-auto-columns: calc((100% - 16px) / 2); 
  }

  .fetchly-slide__media {
    width: 100%;   
    height: 150px;
  }

  .fetchly-slide__img {
    height: 150px;
  }
  .fetchly-slide__label {
    padding: 8px 19dvh;
  }
} 
</style>

<script>
(() => {
  const sectionId = {{ section.id | json }};
  const track = document.getElementById(`SliderTrack-${sectionId}`);
  if (!track) return;

  const slider = track.closest('.fetchly-slider');
  if (!slider) return;

  const dotsWrap = slider.querySelector('[data-dots]');
  if (!dotsWrap) return;

  const slides = Array.from(track.querySelectorAll('.fetchly-slide'));
  if (!slides.length) return;

  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

  const getPageWidth = () => track.clientWidth; // ancho visible del carrusel

  const getPageCount = () => {
    const pageWidth = getPageWidth();
    if (!pageWidth) return 1;
    // scrollWidth incluye todo el contenido; pages = cuánto "pantallas" necesitas
    return Math.max(1, Math.ceil(track.scrollWidth / pageWidth));
  };

  const buildDots = () => {
    const pages = getPageCount();
    dotsWrap.innerHTML = '';

    for (let i = 0; i < pages; i++) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'fetchly-dot';
      btn.dataset.page = String(i);
      btn.setAttribute('aria-label', `Go to page ${i + 1}`);
      btn.setAttribute('aria-current', i === 0 ? 'true' : 'false');
      if (i === 0) btn.classList.add('is-active');

      btn.addEventListener('click', () => scrollToPage(i));
      dotsWrap.appendChild(btn);
    }
  };

  const setActivePage = (pageIndex) => {
    const dots = Array.from(dotsWrap.querySelectorAll('.fetchly-dot'));
    dots.forEach((d, i) => {
      const active = i === pageIndex;
      d.classList.toggle('is-active', active);
      d.setAttribute('aria-current', active ? 'true' : 'false');
    });
  };

  const scrollToPage = (pageIndex) => {
    const pageWidth = getPageWidth();
    const pages = getPageCount();
    const p = clamp(pageIndex, 0, pages - 1);

    track.scrollTo({
      left: pageWidth * p,
      behavior: 'smooth'
    });

    setActivePage(p);
  };

  // Actualiza dot activo según scrollLeft / pageWidth
  let ticking = false;
  const onScroll = () => {
    if (ticking) return;
    ticking = true;

    requestAnimationFrame(() => {
      const pageWidth = getPageWidth();
      if (!pageWidth) { ticking = false; return; }

      const pages = getPageCount();
      const current = clamp(Math.round(track.scrollLeft / pageWidth), 0, pages - 1);
      setActivePage(current);
      ticking = false;
    });
  };

  track.addEventListener('scroll', onScroll, { passive: true });

  // Rebuild dots cuando cambie el tamaño (desktop↔mobile)
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      buildDots();
      onScroll(); // actualiza activo según posición actual
    }, 150);
  });

  // Init
  buildDots();
  setActivePage(0);
})();
</script>


{% schema %}
{
  "name": "Fetchly Designer Slider",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Designers"
    },
    {
      "type": "text",
      "id": "aria_label",
      "label": "ARIA label",
      "default": "Designer slider"
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show dots",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "label", "label": "Label", "default": "DESIGNER 1" },
        { "type": "url", "id": "link", "label": "Link" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Fetchly Designer Slider",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}
